#!/usr/bin/env bash
set -euo pipefail

# Reproduce script for Qwen3-235B-A22B-Instruct-2507 + vLLM + ThunderAgent + OpenHands SWE-bench run.
# Run from any directory. Logs are written next to this script.
#
# NOTE: Ensure `examples/inference/OpenHands/config.toml` is consistent with this script
# (model name, base_url -> http://localhost:${TA_PORT}/v1, tool calling flags, etc.).

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
# Resolve repo root so `python -m ThunderAgent` can import the local ThunderAgent package.
# (This script lives under examples/inference/OpenHands/scripts/reproduce/)
REPO_ROOT="$(git -C "${SCRIPT_DIR}" rev-parse --show-toplevel 2>/dev/null || true)"
if [[ -z "${REPO_ROOT}" ]]; then
  REPO_ROOT="$(cd -- "${SCRIPT_DIR}/../../../../.." && pwd)"
fi

VLLM_PORT="${VLLM_PORT:-8100}"
TA_PORT="${TA_PORT:-8000}"

VLLM_HEALTH_URL="http://localhost:${VLLM_PORT}/health"
TA_HEALTH_URL="http://localhost:${TA_PORT}/health"

VLLM_LOG="${SCRIPT_DIR}/vllm_qwen3_${VLLM_PORT}.log"
TA_LOG="${SCRIPT_DIR}/thunderagent_${TA_PORT}.log"

cleanup() {
  set +e
  if [[ -n "${TA_PID:-}" ]] && kill -0 "${TA_PID}" 2>/dev/null; then
    kill "${TA_PID}" 2>/dev/null
  fi
  if [[ -n "${VLLM_PID:-}" ]] && kill -0 "${VLLM_PID}" 2>/dev/null; then
    kill "${VLLM_PID}" 2>/dev/null
  fi
}
trap cleanup EXIT

wait_for_health() {
  local url="$1"
  local name="$2"
  local timeout_s="${3:-600}"

  local start
  start="$(date +%s)"

  while true; do
    local out=""
    if out="$(curl -sS -m 2 "${url}" 2>&1)"; then
      return 0
    fi

    local now
    now="$(date +%s)"
    if (( now - start >= timeout_s )); then
      echo "[ERROR] ${name} health check failed: timeout after ${timeout_s}s" >&2
      echo "[ERROR] last curl output: ${out}" >&2
      return 1
    fi

    sleep 2
  done
}

cd "${REPO_ROOT}"

echo "[INFO] Starting vLLM on port ${VLLM_PORT} (log: ${VLLM_LOG})"
nohup vllm serve /data/models/Qwen3-235B-A22B-Instruct-2507 \
  --tensor-parallel-size 8 \
  --kv_cache_dtype fp8 \
  --quantization fp8 \
  --enable-auto-tool-choice \
  --tool-call-parser hermes \
  --port "${VLLM_PORT}" \
  >"${VLLM_LOG}" 2>&1 &
VLLM_PID="$!"

echo "[INFO] Waiting for vLLM health: ${VLLM_HEALTH_URL}"
wait_for_health "${VLLM_HEALTH_URL}" "vLLM"

echo "[INFO] Starting ThunderAgent on port ${TA_PORT} (log: ${TA_LOG})"
nohup python -m ThunderAgent \
  --backends "http://localhost:${VLLM_PORT}" \
  --port "${TA_PORT}" \
  >"${TA_LOG}" 2>&1 &
TA_PID="$!"

echo "[INFO] Waiting for ThunderAgent health: ${TA_HEALTH_URL}"
wait_for_health "${TA_HEALTH_URL}" "ThunderAgent"

echo "[INFO] Running OpenHands SWE-bench evaluation"
cd "${REPO_ROOT}/examples/inference"
python -m evaluation.benchmarks.swe_bench.run_infer \
  --config-file OpenHands/config.toml \
  --llm-config vllm_local \
  --agent-cls CodeActAgent \
  --dataset princeton-nlp/SWE-bench_Lite \
  --split test \
  --max-iterations 50 \
  --eval-num-workers 128 \
  --eval-output-dir test

